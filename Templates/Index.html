
<script>
    let imageCounter = 0;
    let mediaRecorders = {};
    let audioChunks = {};

    function addImageGroup() {
        imageCounter++;
        const group = document.createElement('div');
        group.className = 'image-group fade-in';
        group.innerHTML = `
            <div class="group-header">
                <div class="group-title">
                    <span class="group-number">${imageCounter}</span>
                    Image ${imageCounter}
                </div>
                ${imageCounter > 1 ? '<button type="button" class="remove-btn" onclick="removeImageGroup(this)"><i class="fas fa-times"></i></button>' : ''}
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-image"></i> Select Image
                    </label>
                    <input type="file" class="file-input" name="images[]" accept="image/*" required>
                </div>
                <div class="form-group">
                    <div class="audio-section">
                        <div class="audio-label">
                            <i class="fas fa-microphone audio-icon"></i>
                            Voice Note (Optional)
                        </div>
                        <p class="audio-hint">Record live audio in any language - it will be transcribed to English</p>
                        
                        <div class="recorder-controls">
                            <button type="button" class="btn" onclick="startRecording(${imageCounter})" id="start-btn-${imageCounter}">
                                <i class="fas fa-microphone"></i> Start Recording
                            </button>
                            <button type="button" class="btn btn-danger" onclick="stopRecording(${imageCounter})" disabled id="stop-btn-${imageCounter}">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="playRecording(${imageCounter})" disabled id="play-btn-${imageCounter}">
                                <i class="fas fa-play"></i> Play
                            </button>
                        </div>
                        
                        <div id="recorder-status-${imageCounter}" class="recorder-status" style="display: none;">
                            <i class="fas fa-circle"></i>
                            <span>Ready to record</span>
                        </div>
                        
                        <div class="audio-preview" id="audio-preview-${imageCounter}" style="display: none;">
                            <audio controls id="audio-player-${imageCounter}"></audio>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('image-groups').appendChild(group);
    }

    function removeImageGroup(button) {
        const group = button.closest('.image-group');
        const groupId = group.querySelector('.group-number').textContent;
        
        // Clean up any recording resources
        if (mediaRecorders[groupId]) {
            mediaRecorders[groupId].stop();
            delete mediaRecorders[groupId];
        }
        if (audioChunks[groupId]) {
            delete audioChunks[groupId];
        }
        
        group.remove();
        updateGroupNumbers();
    }

    function updateGroupNumbers() {
        const groups = document.querySelectorAll('.image-group');
        groups.forEach((group, index) => {
            const numberElement = group.querySelector('.group-number');
            numberElement.textContent = index + 1;
            
            const titleElement = group.querySelector('.group-title');
            titleElement.innerHTML = `<span class="group-number">${index + 1}</span> Image ${index + 1}`;
            
            // Update button IDs and function calls
            const stopBtn = group.querySelector('[onclick^="stopRecording"]');
            const playBtn = group.querySelector('[onclick^="playRecording"]');
            const statusDiv = group.querySelector('[id^="recorder-status"]');
            const previewDiv = group.querySelector('[id^="audio-preview"]');
            const audioPlayer = group.querySelector('[id^="audio-player"]');
            
            if (stopBtn) stopBtn.setAttribute('onclick', `stopRecording(${index + 1})`);
            if (playBtn) playBtn.setAttribute('onclick', `playRecording(${index + 1})`);
            if (statusDiv) statusDiv.id = `recorder-status-${index + 1}`;
            if (previewDiv) previewDiv.id = `audio-preview-${index + 1}`;
            if (audioPlayer) audioPlayer.id = `audio-player-${index + 1}`;
        });
        imageCounter = groups.length;
    }

    async function startRecording(groupId) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    channelCount: 1,
                    sampleRate: 16000,
                    sampleSize: 16,
                    echoCancellation: true,
                    noiseSuppression: true
                } 
            });
            
            audioChunks[groupId] = [];
            
            // Try different audio formats in order of preference
            const formats = [
                'audio/webm;codecs=opus',
                'audio/webm',
                'audio/mp4',
                'audio/ogg;codecs=opus',
                'audio/wav',
                'audio/mpeg'
            ];
            
            let mediaRecorder;
            let selectedFormat = 'audio/webm'; // default fallback
            
            // Find the first supported format
            for (const format of formats) {
                if (MediaRecorder.isTypeSupported(format)) {
                    selectedFormat = format;
                    console.log(`Using format: ${format}`);
                    break;
                }
            }
            
            console.log(`Selected format: ${selectedFormat}`);
            
            try {
                mediaRecorder = new MediaRecorder(stream, { 
                    mimeType: selectedFormat,
                    audioBitsPerSecond: 128000
                });
            } catch (e) {
                console.log('Failed with specific format, using default:', e);
                mediaRecorder = new MediaRecorder(stream);
            }
            
            mediaRecorders[groupId] = mediaRecorder;
            
            mediaRecorders[groupId].ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks[groupId].push(event.data);
                }
            };
            
            mediaRecorders[groupId].onstop = () => {
                // Use the actual mime type from the recorder
                const mimeType = mediaRecorders[groupId].mimeType || 'audio/webm';
                const audioBlob = new Blob(audioChunks[groupId], { type: mimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Store the audio data as base64
                const reader = new FileReader();
                reader.onloadend = function() {
                    const base64data = reader.result;
                    // Create a hidden input to store the audio data
                    let hiddenInput = document.querySelector(`input[name="recorded_audio_${groupId}"]`);
                    if (!hiddenInput) {
                        hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = `recorded_audio_${groupId}`;
                        document.getElementById('upload-form').appendChild(hiddenInput);
                    }
                    hiddenInput.value = base64data;
                    
                    // Also store the mime type for server processing
                    let mimeInput = document.querySelector(`input[name="audio_mime_${groupId}"]`);
                    if (!mimeInput) {
                        mimeInput = document.createElement('input');
                        mimeInput.type = 'hidden';
                        mimeInput.name = `audio_mime_${groupId}`;
                        document.getElementById('upload-form').appendChild(mimeInput);
                    }
                    mimeInput.value = mimeType;
                };
                reader.readAsDataURL(audioBlob);
                
                // Update UI
                document.getElementById(`audio-player-${groupId}`).src = audioUrl;
                document.getElementById(`audio-preview-${groupId}`).style.display = 'block';
                document.getElementById(`play-btn-${groupId}`).disabled = false;
                updateStatus(groupId, `Recorded audio is ready (${mimeType})`, 'recorded');
                
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorders[groupId].start(1000);
            updateStatus(groupId, 'Recording... Click stop when finished', 'recording');
            document.getElementById(`stop-btn-${groupId}`).disabled = false;
            document.getElementById(`start-btn-${groupId}`).disabled = true;
            
        } catch (error) {
            console.error('Error starting recording:', error);
            updateStatus(groupId, 'Error accessing microphone: ' + error.message, 'error');
        }
    }

    function stopRecording(groupId) {
        if (mediaRecorders[groupId] && mediaRecorders[groupId].state !== 'inactive') {
            mediaRecorders[groupId].stop();
            document.getElementById(`stop-btn-${groupId}`).disabled = true;
            document.getElementById(`start-btn-${groupId}`).disabled = false;
        }
    }

    function playRecording(groupId) {
        const audioPlayer = document.getElementById(`audio-player-${groupId}`);
        if (audioPlayer) {
            audioPlayer.play().catch(e => {
                console.error('Error playing audio:', e);
                updateStatus(groupId, 'Error playing audio', 'error');
            });
        }
    }

    function updateStatus(groupId, message, type) {
        const statusDiv = document.getElementById(`recorder-status-${groupId}`);
        statusDiv.innerHTML = `<i class="fas fa-circle"></i><span>${message}</span>`;
        statusDiv.className = `recorder-status ${type}`;
        statusDiv.style.display = 'flex';
    }

    // Initialize with one image group
    document.addEventListener('DOMContentLoaded', function() {
        addImageGroup();
        
        // Handle form submission
        document.getElementById('upload-form').addEventListener('submit', function() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
        });
    });
</script>
